#!/bin/bash

# Sure AI Chat Test Script
# This script helps you test the local LLM integration

echo "ğŸ¤– Sure AI Chat Test"
echo "===================="

# Check if Ollama is accessible
echo "ğŸ” Checking Ollama connectivity..."
if curl -s http://localhost:11434/api/version > /dev/null 2>&1; then
    echo "âœ… Ollama is running locally"
    
    # Check if web container can access Ollama
    if docker compose exec -T web curl -s http://host.docker.internal:11434/api/version > /dev/null 2>&1; then
        echo "âœ… Web container can access Ollama"
    else
        echo "âŒ Web container cannot access Ollama"
        echo "   Check your Docker network configuration"
        exit 1
    fi
else
    echo "âŒ Ollama is not running"
    echo "   Run: ollama serve"
    exit 1
fi

# Check available models
echo ""
echo "ğŸ“‹ Available Ollama models:"
ollama list | grep -E "(NAME|llama3\.2)" || echo "   No compatible models found"

# Check if llama3.2 is available
if ollama list | grep -q "llama3.2"; then
    echo "âœ… llama3.2 model is available"
else
    echo "âš ï¸  llama3.2 model not found"
    echo "   Download with: ollama pull llama3.2"
fi

echo ""
echo "ğŸ§ª Testing Ollama directly..."
echo "Sending test request to Ollama..."

# Test Ollama directly with a simple request
test_response=$(curl -s -X POST http://localhost:11434/api/generate \
  -H "Content-Type: application/json" \
  -d '{
    "model": "llama3.2",
    "prompt": "What is 2+2?",
    "stream": false
  }' | jq -r '.response' 2>/dev/null)

if [ -n "$test_response" ] && [ "$test_response" != "null" ]; then
    echo "âœ… Ollama responded: ${test_response:0:100}..."
else
    echo "âŒ Ollama test failed"
    echo "   Try: ollama run llama3.2 'What is 2+2?'"
fi

echo ""
echo "ğŸŒ Sure Application Status:"
if curl -s http://localhost:3000 > /dev/null 2>&1; then
    echo "âœ… Sure web application is running"
    echo ""
    echo "ğŸ¯ How to test AI chat:"
    echo "   1. Open: http://localhost:3000"
    echo "   2. Create an account or log in"
    echo "   3. Look for 'Chat' or 'AI Assistant' in the navigation"
    echo "   4. Start a conversation!"
    echo ""
    echo "ğŸ’¬ Example questions to try:"
    echo "   â€¢ 'How can I budget my monthly expenses?'"  
    echo "   â€¢ 'What's the best way to track my spending?'"
    echo "   â€¢ 'Help me categorize my transactions'"
    echo ""
    echo "ğŸ” If AI features don't work:"
    echo "   â€¢ Check Docker logs: docker compose logs web | grep -i ollama"
    echo "   â€¢ Verify environment: echo \$OLLAMA_BASE_URL"
    echo "   â€¢ Test connectivity: ./bin/ai-test"
else
    echo "âŒ Sure web application is not responding"
    echo "   Run: docker compose up -d"
fi

echo ""
echo "ğŸ‰ Setup complete! Your local AI chat should be working."
