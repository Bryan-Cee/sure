#!/bin/bash

# Sure Docker Verification Script
# This script checks if the Sure application is running correctly

echo "üîç Sure Application Health Check"
echo "================================"

# Check if Docker containers are running
echo "üì¶ Checking Docker containers..."
if docker compose ps | grep -q "Up"; then
    echo "‚úÖ Docker containers are running"
    docker compose ps --format "table {{.Service}}\t{{.State}}\t{{.Status}}" 2>/dev/null || docker compose ps
else
    echo "‚ùå Docker containers are not running"
    echo "   Run: docker compose up -d"
    exit 1
fi

echo ""

# Check web application response
echo "üåê Checking web application..."
if curl -s -o /dev/null -w "%{http_code}" http://localhost:3000 | grep -q "302"; then
    echo "‚úÖ Web application is responding (redirecting to registration)"
    echo "   üéâ Sure is ready! Open http://localhost:3000 in your browser"
else
    echo "‚ùå Web application is not responding"
    echo "   Check logs with: docker compose logs web"
    exit 1
fi

echo ""

# Check database connection
echo "üóÑÔ∏è  Checking database connection..."
if docker compose exec -T db pg_isready -U maybe_user > /dev/null 2>&1; then
    echo "‚úÖ Database is healthy and accepting connections"
else
    echo "‚ùå Database connection issues"
    echo "   Check logs with: docker compose logs db"
fi

echo ""

# Check Ollama connectivity (optional)
echo "ü§ñ Checking Ollama connectivity..."
if curl -s http://host.docker.internal:11434/api/version > /dev/null 2>&1; then
    echo "‚úÖ Ollama is accessible from Docker containers"
    if docker compose exec -T web curl -s http://host.docker.internal:11434/api/version > /dev/null 2>&1; then
        echo "‚úÖ Ollama connectivity confirmed from web container"
    else
        echo "‚ö†Ô∏è  Ollama not accessible from web container"
    fi
elif curl -s http://localhost:11434/api/version > /dev/null 2>&1; then
    echo "‚ö†Ô∏è  Ollama is running on host but not accessible from Docker"
    echo "   This is normal - AI features will be limited"
else
    echo "‚ÑπÔ∏è  Ollama not running - AI features will be disabled"
    echo "   To enable: ollama serve && ollama pull llama3.2"
fi

echo ""

# Show useful information
echo "üìã Quick Commands:"
echo "   ‚Ä¢ Open app:       http://localhost:3000"
echo "   ‚Ä¢ View logs:      docker compose logs -f"
echo "   ‚Ä¢ Stop app:       docker compose down"
echo "   ‚Ä¢ Restart:        docker compose restart"
echo "   ‚Ä¢ Update code:    docker compose up -d --build"

echo ""
echo "üéØ Status: Sure is running successfully!"
